#!/bin/sh

# The way in which we download and/or install the YUM repository RPMs is unsafe,
# because it assumes specific versions at specific URLs.  Ideally, we would have
# a way to discover the latest versions and grab them.

on_error_die()
{
    if [ $? -ne 0 ]; then
        echo 'FAILED!'
        echo $1
        exit 1
    else
        echo 'done'
    fi
}

extra_repo=
case $1 in
    test|testing)     extra_repo='--enablerepo=osg-testing';;
    dev|development)  extra_repo='--enablerepo=osg-development';;
    '') ;;
    *)
        echo "$0: unknown option '$1'"
        echo "usage: $0 [testing|development]"
        exit 1
        ;;
esac

epel_rpm=`rpm -q epel-release 2>/dev/null`
if [ $? -eq 1 ]; then
    release=`cat /etc/redhat-release`
    case $release in
        *5.* )
            rpm_name='epel-release-5-4.noarch.rpm'
            rpm_path='http://download.fedoraproject.org/pub/epel/5/i386/epel-release-5-4.noarch.rpm'
            osg_name='osg-el5-release-latest.rpm'
            ;;
        *6.* )
            rpm_name='epel-release-6-5.noarch.rpm'
            rpm_path='http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-5.noarch.rpm'
            osg_name='osg-el6-release-latest.rpm'
            ;;
        * )
            echo 'Could not determine OS release'
            exit 1
            ;;
    esac

    echo -n "Downloading $rpm_name... "
    if [ ! -f $rpm_name ]; then
        wget --quiet $rpm_path
        on_error_die "Could not download $rpm_name"
    else
        echo 'already downloaded'
    fi

    echo -n 'Installing epel-release... '
    rpm --install --nosignature $rpm_name
    on_error_die 'Could not install epel-release RPM'
else
    echo 'Already installed: epel-release'
fi

osg_rpm=`rpm -q osg-release 2>/dev/null`
if [ $? -eq 1 ]; then
    echo -n 'Installing osg-release... '
    rpm --upgrade http://repo.grid.iu.edu/$osg_name
    on_error_die 'Could not install osg-release'
else
    echo 'Already installed: osg-release'
fi

echo -n 'Updating osg-release... '
yum -y --quiet update osg-release
on_error_die 'Could not update osg-release'

# Always erase and install, to get latest
rpm -e osg-test >/dev/null 2>&1
echo -n "Install osg-test... "
yum -y --quiet $extra_repo install osg-test
on_error_die "Could not install osg-test"
echo -n 'Verify osg-test... '
rpm --verify osg-test
on_error_die "Could not verify osg-test"
